# 兑奖码生成

楼主了解的兑奖码有两种方式：

- 加密生成、解密验证
- 随机生成、对等验证

讲原理前先说一下生成码，兑奖码的编码问题，列如E7NE3KD7HN2L上面这个兑奖码由字母和数字组成，所以会有编码表，就会有表的长度问题（考虑z和2的区别）。

这里定义24位的编码表（ABCDEFGHIJKLMNOPQRSTUVWSYZ0123456789）去掉字母B、I、U、V、S、O、Z数组0、1、2、5、8剩下24位（ACDEFGHJKLMNPQRSTWY34679）

### 加密解密方法

看一下24位编码表对应兑奖码长度关系

 $1 -> 24^1

 $2 -> 24^2

 $3 -> 24^3 

 $n-> 24^n

当n为6时候，24位编码表可以组成191102976个兑奖码，近两亿个。

2^28 = 268435456大于24^6,2^27 = 134207728小于24^6；所以可以得出结论用长度为6的24位编码生成亿级别的兑奖码，并用27位的二进制数（十进制134207728，最多可以生成134207728个兑奖码）来对应。编码位生成的数量一定要大于二进制表示的范围。

**加密方法：**

标记位|加密位|数字位

标记位：（这里假设会有30个批次的产品需要兑奖，所以长度为5，2^5 > 30，长度不足补位）标记产品批次或中奖信息，length:5。

加密位：用于和数字位组合防爆刷,根据标记位生成（这里要根据生成串的长短来确认加密位的长度，加密位很短会使生成码部分位置有规律性，所以要限制兑奖码最小长度。）

数字位：根据生成数转换成二进制，长度不足补位，length:27。

加密位长度计算方法：当前是24位编码表，用6位长度来对应27位二进制数，所以用4.5位标记字符，也就是9位标识两个字符。当编码表长度变得时候也可以根据上面的来计算一个字符对应二进制的长度。所以假设现在要生成12位的兑奖码，那么需要54位的二进制数，那么加密位也就是54-27-5 = 22位；10位兑奖码对应的加密位是45-27-5=13位。

![code_en](http://ocaya4boy.bkt.clouddn.com/code_en.jpeg)



解密过程：逆过来先把兑奖码字符转换成二进制数，按照规则拆分为标记位和混合位。根据标记位获取加密位，拆分混合位获取数字位和加密位，验证加密位和数字位。

兑奖码的使用情况可以用数字位标记，这样表中以自增主键的方式查询是否使用效率会很高。



**随机生成 对等验证**

MD5（标记位 + 时间戳 + 随机码）

md5后为32位的16进制数，现在要生成12位兑奖码，所以要转换成54位二进制，这样可以将32位分为四段，一个8位16进制数转换成27位进制数，多余的位置去掉，这样一个8位16进制生成6位兑奖码，两个拼接成一个12位兑奖码，一个16进制的MD5值可以生成两个兑奖码。

![code_rand](http://ocaya4boy.bkt.clouddn.com/code_rand.jpeg)

这种方式生成的码都是直接入库的，因为没有解密方式；数据很多的时候可以分表处理。















